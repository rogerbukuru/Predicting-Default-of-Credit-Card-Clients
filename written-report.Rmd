---
title: "Predicting default of credit card clients"
author: "Roger Bukuru"
date: "`r Sys.Date()`"
output: 
  pdf_document:
      toc: true
      number_sections: true
      df_print: kable
      fig_width: 5
      fig_height: 5
      fig_caption: true
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

\pagebreak

# Import Data 

```{r, echo = FALSE}

rm(list = ls())
library(readxl)
library(tidyverse)
library(knitr)
library(ggplot2)
library(dplyr)
library(psych)

file_path = "./data/default of credit card clients.xls"

credit_default_data = as_tibble(read_xls(file_path))

colnames(credit_default_data) = as.character(credit_default_data[1, ])
                                
credit_default_data = credit_default_data[-1,]


```

# Introduction

One of the many functions of a bank is the ability to provide its customers with loans or credit facilities. These channels provide banks with the opportunity to generate additional revenues by means of gaining interest off the back of these financial instruments. \newline

However these instruments have an intrinsic risk once awarded to a customer, customers may default in their repayments of such loans or credit facilities. In this research, we will focus on credit card facilities, specifically credit card clients in Taiwan. We will be exploring the probability of clients defaulting on their credit card facility given a set of features such as their demographic information (like gender, education, marital status, and age) to financial behaviors (including payment history, bill statement amounts, and previous payment amounts). The exploration will aim to provide statistical techniques to better manage credit risk default. Credit risk here means, the probability of a delay in the repayment of the credit granted. \newline 

Furthermore, we aim to explore given the above-mentioned features, which features/factors are more likely to affect a customer defaulting e.g. are younger customers more likely to default than older clients, and given these factors what is the probability of a customer defaulting? This will be done by exploring established techniques such as employing customer risk segmentation by conducting clustering techniques such as k-means and Linear Discriminant Analysis (LDA) techniques\cite{merikoski2018predicting}. To assess the effectiveness of these techniques we will explore and compare them to Support Vector Machines (SVMs). As our data has many input variables, feature extraction methods such as  PCA and Autoencoders will be explored before performing the above clustering and classification techniques. The repository of this project is available at 

# Exploratory Data Analysis

## Feature Analysis

```{r, echo = FALSE}

credit_default_data = credit_default_data %>%
                      mutate(across(where(is.character), as.numeric))

colnames(credit_default_data)
#summary(credit_default_data)
stats = describe(credit_default_data, na.rm = FALSE, skew= FALSE)
round(stats,2)
```
- Education and Marriage have some unreported categories
- 
```{r, echo = FALSE}
response_variable = as.numeric(credit_default_data$`default payment next month`) %>%
                    as.tibble() %>%
                    rename(., Class = value)


default_yes = response_variable %>%
              filter(Class == 1)


default_no =  response_variable %>%
              filter(Class == 0)

agg_data = response_variable %>%
           group_by(Class) %>%
           summarise(Count = n()) %>%
           mutate(Percentage = Count /sum(Count) *100)

percentage_yes = nrow(default_yes)/nrow(credit_default_data) *100
percentage_no = nrow(default_no)/nrow(credit_default_data) *100  

ggplot(agg_data, aes(x = factor(Class, labels = c("No", "Yes")), y = Count, fill = factor(Class, labels = c("No", "Yes")))) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(x = "Default payment next month", y = "Number of Clients", title = "Class Distribution") +
  scale_fill_manual(values = c("No" = "darkgreen", "Yes" = "red")) +  # Customize bar colors
  theme_minimal()+
  theme(legend.position = "none")  # Remove the legend
```

```{r, echo = FALSE}
limit_balances  = credit_default_data |>
                  drop_na(LIMIT_BAL) |>
                  select(LIMIT_BAL) |>
                  as.matrix() |>
                  as.vector() |>
                  as.numeric()


average_limit_balance = mean(limit_balances)
range(limit_balances)

male_average_credit_limit = credit_default_data |>
                            filter(SEX == 1) |>
                            select(LIMIT_BAL) |>
                            as.matrix() |>
                            as.vector() |>
                            as.numeric() |>
                            mean()

female_average_credit_limit = credit_default_data |>
                            filter(SEX == 2) |>
                            select(LIMIT_BAL) |>
                            as.matrix() |>
                            as.vector() |>
                            as.numeric() |>
                            mean()

minimum = min(limit_balances)
first_quantile = quantile(limit_balances, 0.25)
median_point = quantile(limit_balances, 0.50)
third_quantile = quantile(limit_balances, 0.75)
maximum = max(limit_balances)

ggplot(credit_default_data, aes(x="", y=limit_balances)) +
  geom_boxplot(fill="lightblue", color="black") +
  labs(title="Credit Limit Five Number Summary", x="", y="Credit Limit") +
  theme_minimal()
```


\begin{itemize}
    \item The minimum credit limit balance was NT\$ 10 000 
    \item 25\% of customers had credit limit balances of NT\$ 50 000 or less, indicating that 75\% of clients had credit limit balances above NT\$ 50,000.
    \item The median credit limit was  NT\$ 140 000, indicating that 50\% of customers have credit limit balances less than NT\$ 140 000 whilst another 50\% of customers have credit limit balances above NT\$ 140 000.
    \item 75\% of customers had credit limit balances below NT\$ 240 000, whilst 25\% of customers had credit limit balances above NT\$ 240 000
    \item The maximum credit limit amount was NT\$ 1 000 000 
    \item The average male credit limit balance was NT\$ 163519.82 and the average female credit limit balance was NT\$ 170086.46
    \item Customer ages ranged from 21 to 79 years old, with the average age being 35 years old.
\end{itemize}

The summary above suggests the following; there is significant variability in the credit limit balances that are given to customers as the limits range from NT\$ 10 000 to  NT\$ 1 000 000. Furthermore, we note that the median value is closer to the third quantile than it is to the first, indicating that the data is right-skewed, which means that there is a large number of customers who have credit limits on the lower end of the range, with fewer individuals having higher credit limits. The significant difference between the maximum value and the third quantile finally indicates that outliers exist on the higher end of the credit limit balances.


```{r, echo = FALSE}
credit_spending = credit_default_data %>%
                  select(LIMIT_BAL, BILL_AMT1) %>%
                  mutate(across(everything(), as.numeric)) %>%
                  mutate(`Credit Utilization` = BILL_AMT1) %>%
                  ungroup()
credit_spending = credit_spending %>%
                  mutate(`Percentage Utilized`= round((`Credit Utilization`/LIMIT_BAL)*100,2))


ggplot(credit_spending, aes(x = `Percentage Utilized`)) +
  geom_histogram(aes(y=..density..),binwidth = 5, # Adjust binwidth based on your data's distribution and scale
                 fill = "steelblue", color = "black") +
  xlim(0, 200)+
  labs(title = "Distribution of Credit Utilization",
       x = "Credit Utilization (%)",
       y = "# of Customers") +
  theme_minimal() 
```


\begin{itemize}
    \item There are a few customers that have exceeded their credit limit facility. Indicating several default risk customers.
    \item Overall the distribution is left-skewed, indicating that more customers have utilized a large portion of their credit facility than less. This could indicate that several customers could be at risk of defaulting as they owe more money.  
\end{itemize}


## Data Cleaning


```{r, echo = FALSE}

# Marriage and Education and to other cateogry
credit_default_data = credit_default_data %>%
                      rename(PAY_1 = PAY_0)%>% 
                      rename(DEFAULT_PAYMENT_NEXT_MONTH = `default payment next month`)

marriage_cateogory_codes = c(1,2,3)   # From data description
education_category_codes = c(1,2,3,4) # From data description

marriage_stats = credit_default_data%>%
                 group_by(MARRIAGE)%>%
                 summarise(Total = n())

marriage_stats

education_stats = credit_default_data%>%
                 group_by(EDUCATION)%>%
                 summarise(Total = n())

education_stats

# Add unknown category to the 'Other' category for both Marriage and Education 
credit_default_data  = credit_default_data %>%
                       mutate(MARRIAGE = if_else(!(MARRIAGE %in% marriage_cateogory_codes), 3, MARRIAGE),
                       EDUCATION = if_else(!(EDUCATION %in% education_category_codes), 4, EDUCATION)
                       )
        

marriage_stats_2 = credit_default_data%>%
                 group_by(MARRIAGE)%>%
                 summarise(Total = n())

marriage_stats_2

education_stats_2 = credit_default_data%>%
                 group_by(EDUCATION)%>%
                 summarise(Total = n())

education_stats_2


```

```{r, echo = FALSE}

# Payment History where value is -2 and 0, aggregate under -1

payment_history = c("PAY_1", "PAY_2", "PAY_3", "PAY_4", "PAY_5","PAY_6")

for (p in payment_history) {
  indices = which(credit_default_data[,p] <= 0)
  credit_default_data[indices, p] = -1
}

```

```{r, echo = FALSE}
payment_history_categorical = paste("PAY_", 1:6, sep = "")
categorical_feature_names = c("SEX", "EDUCATION", "MARRIAGE", "DEFAULT_PAYMENT_NEXT_MONTH", payment_history_categorical)
credit_default_data = credit_default_data%>%
                      mutate(across(matches(categorical_feature_names), as.factor))

#summary(credit_default_data)
# Split Data

set.seed(10032024)
dataSize = nrow(credit_default_data)
trainingSize = floor(0.75*dataSize)

trainingDataIndices = sample(seq_len(dataSize), size = trainingSize)

training_data = credit_default_data[trainingDataIndices,]
testing_data  = credit_default_data[-trainingDataIndices,]

```


```{r, echo = FALSE}
library(corrplot)
X_categorical = training_data %>%
              select(where(is.factor))

X_continous = training_data %>%
              select(where(is.double))

X_continous = X_continous[, -1]

#summary(X_categorical)

corr_matrix = cor(X_continous)
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))


corrplot(corr_matrix, method = "color", col = col(200), 
         type = "full", order = "original", 
         addCoef.col = "white",
         tl.col = "black", tl.srt = 45,
         tl.pos = "lt",
         tl.cex = 0.6, cl.cex = 0.7,
         number.cex = 0.5
         )

```

We observe from the correlation matrix, that some features have high correlations with each other

- BILL_AMT1 and BILL_AMT2 have  p = 0.95
- BILL_AMT2 and BILL_AMT3 have  p = 0.92
- BILL_AMT4 and BILL_AMT5 have  p = 0.94

## Feature Selection



## Feature Extraction

### Principal Component Analysis

```{r, echo= FALSE}

library(ggplot2)
library(scatterplot3d)
library(plotly)

mu_x_continous = apply(X_continous, 2, mean)
X_continous_c = as.matrix(apply(X_continous, 2, function(X_continous)(X_continous - mean(X_continous))) %>% as.tibble())
  
sigma_matrix   = cov(X_continous_c)
eigen_decomp   = eigen(sigma_matrix)

eigenvalues   = eigen_decomp$values 
eigenvectors  = as.matrix(eigen_decomp$vectors)
colnames(eigenvectors) = paste("PC", 1:nrow(sigma_matrix), sep = "")


total_variance = sum(eigenvalues)
variance_explained = eigenvalues/total_variance
pca_data = data.frame(PCA = 1:nrow(sigma_matrix), `Variance Explained` = variance_explained)

# Scree Plot

ggplot(pca_data, mapping = aes(x = PCA, y = Variance.Explained)) +
      geom_point() +
      geom_line()

# Suggest that the first 3 PCA
var_first_3 = sum(variance_explained[1:3])

pca_scores =  t(tcrossprod(eigenvectors, X_continous_c)) %>% as.tibble()
colnames(pca_scores) = colnames(eigenvectors)

```

```{r, echo = FALSE}
scatterplot3d(x = pca_scores$PC1, y = pca_scores$PC2, z = pca_scores$PC3, main = "Principal Components",
              xlab = "PC1", ylab = "PC2", zlab = "PC3", pch = 19, color = "blue", cex.axis = 0.5)

#fig <- plot_ly(pca_scores, x = ~PC1, y = ~PC2, z = ~PC3, type = 'scatter3d', mode = 'markers',
#               marker = list(size = 5, color = 'blue'))

# Customize the layout
#fig <- fig %>% layout(title = '3D Scatter Plot',
#                      scene = list(xaxis = list(title = 'PC1'),
#                                   yaxis = list(title = 'PC2'),
#                                   zaxis = list(title = 'PC3')))
#fig
#svd_decomp = svd(continous_features)

#continous_vars = credit_default_data%>%
 #                select(where(is.))

#classic_pca = prcomp(X_continous_c, retx = TRUE, center = FALSE, scale. = FALSE)
#pca_scores_two = classic_pca$x %>% as.tibble()

#scatterplot3d(x = pca_scores_two$PC1, y = pca_scores_two$PC2, z = pca_scores_two$PC3, main = "Principal Components",
             # xlab = "PC1", ylab = "PC2", zlab = "PC3", pch = 19, color = "blue")

#classic_pca$x == pca_scores
```


### Autoencoders

```{r, echo = FALSE}

```


# Model Engineering

# Model Evaluation

## Conclusion


